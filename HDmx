#!/usr/bin/env python

import liblo, sys,time
import DmxPy

# create server, listening on port 3000
try:
    server = liblo.Server(3000)
except liblo.ServerError, err:
    print str(err)
    sys.exit()

try:
    dmx = DmxPy.DmxPy('/dev/ttyUSB0')
except:
    print "Unable to open /dev/ttyUSB0"
    sys.exit()

def send(path, args):
    chan, val = args
    val = int(round(val))
    dmx.setChannel(chan, val)
    dmx.render()
    print "DMX '%d' at '%d'" % (chan, val)

def blackout(path, args):
    dmx.blackout()
    dmx.render()
    print "DMX all off"

def allon(path, args):
    dmx.full()
    dmx.render()
    print "DMX all on"

# register methods
server.add_method("/dmx/set", 'ii', send)
server.add_method("/dmx/set", 'if', send)
server.add_method("/dmx/blackout", None, blackout)
server.add_method("/dmx/all", None, allon)
server.add_method("/dmx/off", None, blackout)

# loop and dispatch messages every 20ms
while True:
    server.recv(20)
